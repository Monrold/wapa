---
const { eventName = "PageView", customData = {} } = Astro.props;
---

<script is:inline>
document.addEventListener("DOMContentLoaded", () => {
  try {
    const eventNameLiteral = eventName || "PageView";
    const eventDataLiteral = customData || {};

    // üîë Generar un event_id compatible con todos los navegadores
    function generateEventId() {
      if (crypto.randomUUID) return `pgvw-${crypto.randomUUID()}`;
      // Fallback para navegadores antiguos
      return 'pgvw-' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }
    const eventId = generateEventId();

    console.log("üì§ Disparando PageView:", eventNameLiteral, eventDataLiteral, "ID:", eventId);

    // Funci√≥n para leer cookies
    function getCookie(name) {
      const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      return match ? match[2] : null;
    }

    // --- Pixel del navegador ---
    if (window.fbq) {
      try {
        fbq("track", eventNameLiteral, {
          ...eventDataLiteral,
          event_id: eventId, // üîë Muy importante para deduplicaci√≥n
        });
        console.log("‚úÖ Pixel navegador enviado con ID:", eventId);
      } catch (err) {
        console.error("‚ùå Error enviando Pixel navegador:", err);
      }
    } else {
      console.warn("‚ö†Ô∏è Pixel de Facebook no est√° definido (window.fbq)");
    }

    // --- API del servidor (CAPI) ---
    fetch("https://metaevents.soporte-draw.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json", Accept: "application/json" },
      body: JSON.stringify({
        event_name: eventNameLiteral,
        event_time: Math.floor(Date.now() / 1000),
        action_source: "website",
        event_source_url: window.location.href,
        user_data: {
          client_ip_address: "NO_HASH_IP",
          client_user_agent: navigator.userAgent,
          fbp: getCookie("_fbp"),
          fbc: getCookie("_fbc"),
        },
        custom_data: eventDataLiteral,
        event_id: eventId, // üîë Mandar el mismo ID al Worker
      }),
    }).catch((err) => console.error("‚ùå Error CAPI PageView:", err));

  } catch (err) {
    console.error("‚ùå Error al disparar PageView:", err);
  }
});
</script>
