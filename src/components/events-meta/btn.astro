---
const {
  eventName = "InitiateCheckout",
  eventData = { value: 0, currency: "MXN" },
  href,
  text,
  className,
} = Astro.props;
---

<div>
  <a href={href} class={`trackBtn ${className}`}>
    {text}
  </a>

  <script is:inline>
    (function () {
      function getCookie(name) {
        const match = document.cookie.match(
          new RegExp("(^| )" + name + "=([^;]+)"),
        );
        return match ? match[2] : null;
      }

      function sendEvent(eventName, customData, href) {
        const eventId = `${Date.now()}-${Math.floor(Math.random() * 10000)}`;
        const fbp = getCookie("_fbp");
        const fbc = getCookie("_fbc");

        const user_data = {
          client_ip_address: "NO_HASH_IP",
          client_user_agent: navigator.userAgent,
          ...(fbp && { fbp }),
          ...(fbc && { fbc }),
        };

        console.log("ðŸš€ Enviando evento:", {
          eventName,
          eventId,
          customData,
          user_data,
        }); // ðŸ‘ˆ AquÃ­

        // Pixel navegador
        if (window.fbq)
          fbq("track", eventName, { ...customData, event_id: eventId });

        // CAPI
        try {
          const payload = JSON.stringify({
            event_name: eventName,
            event_id: eventId,
            event_time: Math.floor(Date.now() / 1000),
            action_source: "website",
            event_source_url: window.location.href,
            user_data,
            custom_data: customData,
          });
          navigator.sendBeacon(
            "https://metaevents.soporte-draw.workers.dev",
            payload,
          );
        } catch (err) {
          console.error(err);
        }

        // Navegar despuÃ©s de enviar
        setTimeout(() => {
          window.location.href = href;
        }, 150);
      }

      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.currentScript.previousElementSibling;
        if (!btn) return;
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          sendEvent(
            eventName,
            { value: eventData.value, currency: eventData.currency },
            btn.href,
          );
        });
      });
    })();
  </script>
</div>
