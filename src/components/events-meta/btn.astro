---
const {
  href,
  text,
  className,
  eventName = "InitiateCheckout",
  eventData = { value: 0, currency: "MXN" },
} = Astro.props;
---

<a 
  href={href} 
  class={`trackBtn ${className}`}
>
  {text}
</a>

<script is:inline>
  (function () {
    function getCookie(name) {
      return document.cookie
        .split("; ")
        .find((row) => row.startsWith(name + "="))
        ?.split("=")[1];
    }

    function sendEvent(btn) {
      // ðŸ”¹ Leer siempre desde data-attributes
      const eventName = btn.dataset.eventName;
      const customData = btn.dataset.eventData
        ? JSON.parse(btn.dataset.eventData)
        : { value: 0, currency: "MXN" };

      const eventId = `${Date.now()}-${Math.floor(Math.random() * 10000)}`;
      const fbp = getCookie("_fbp");
      const fbc = getCookie("_fbc");

      const user_data = {
        client_ip_address: "NO_HASH_IP",
        client_user_agent: navigator.userAgent,
        ...(fbp && { fbp }),
        ...(fbc && { fbc }),
      };

      console.log("ðŸš€ Enviando evento:", { eventName, eventId, customData, user_data });

      // Pixel navegador
      if (window.fbq) fbq("track", eventName, { ...customData, event_id: eventId });

      // CAPI
      try {
        const payload = JSON.stringify({
          event_name: eventName,
          event_id: eventId,
          event_time: Math.floor(Date.now() / 1000),
          action_source: "website",
          event_source_url: window.location.href,
          user_data,
          custom_data: customData,
        });
        navigator.sendBeacon("https://metaevents.soporte-draw.workers.dev", payload);
      } catch (err) {
        console.error(err);
      }

      // Navegar despuÃ©s de enviar (delay reducido)
      setTimeout(() => window.location.href = btn.href, 150);
    }

    document.addEventListener("DOMContentLoaded", () => {
      // ðŸ”¹ Selecciona solo botones TrackButton
      const buttons = document.querySelectorAll("a[data-event-name]");

      buttons.forEach((btn) => {
        if (btn.dataset.listenerAttached === "true") return; // evitar duplicados
        btn.dataset.listenerAttached = "true";

        btn.addEventListener("click", (e) => {
          e.preventDefault();
          sendEvent(btn);
        });
      });
    });
  })();
</script>
