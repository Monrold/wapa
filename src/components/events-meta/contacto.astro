---
// ContactButton.astro
const {
  href,
  text = "Contactar",
  eventName = "Contact",
  eventData = {},
  className,
} = Astro.props;

// ID 칰nico no es necesario si usamos dataset
---

<a
  href={href}
  target="_blank"
  class={className}
  data-event-name={eventName}
  data-event-data={JSON.stringify(eventData)}
>
  {text}
</a>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.querySelector("a[data-event-name]");
    if (!btn) {
      console.error("No se encontr칩 el bot칩n de contacto");
      return;
    }

    const eventName = btn.dataset.eventName;
    const eventData = JSON.parse(btn.dataset.eventData);

    // 游릭 Funci칩n para leer cookies en navegador
    function getCookie(name) {
      return document.cookie
        .split("; ")
        .find((row) => row.startsWith(name + "="))
        ?.split("=")[1];
    }

    btn.addEventListener("click", (e) => {
      e.preventDefault();
      console.log("Click detectado en ContactButton");

      // --- Pixel del navegador
      if (window.fbq) {
        fbq("track", eventName, eventData);
        console.log("Evento " + eventName + " disparado");
      }

      // --- API del servidor (CAPI)
      fetch("https://metaevents.soporte-draw.workers.dev", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          event_name: eventName,
          event_time: Math.floor(Date.now() / 1000),
          action_source: "website",
          event_source_url: window.location.href,
          user_data: {
            client_ip_address: "NO_HASH_IP",
            client_user_agent: navigator.userAgent,
            fbc: getCookie("_fbc"), // 游릭 Agregamos FBC
            fbp: getCookie("_fbp"), // 游릭 Agregamos FBP
          },
          custom_data: eventData,
        }),
      }).catch((err) => console.error("Error CAPI:", err));

      // --- Abrir WhatsApp despu칠s de 200ms
      setTimeout(() => {
        window.open(btn.href, "_blank");
      }, 200);
    });
  });
</script>
